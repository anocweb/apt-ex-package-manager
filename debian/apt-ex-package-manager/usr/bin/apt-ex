#! /usr/bin/python3
"""Launcher script for Apt-Ex Package Manager"""
import sys
import os
import fcntl
from PyQt6.QtWidgets import QApplication
from PyQt6.QtNetwork import QLocalSocket, QLocalServer
from PyQt6.QtCore import QByteArray, Qt

# Add installed package to path
sys.path.insert(0, '/usr/lib/python3/dist-packages')

from config.app_config import AppConfig
from controllers.application_controller import ApplicationController

def main():
    config = AppConfig.parse_arguments()
    app = QApplication(sys.argv)
    
    # Single instance check with file lock
    lock_file_path = f"/tmp/apt-ex-package-manager-{os.getuid()}.lock"
    lock_file = open(lock_file_path, 'w')
    
    try:
        fcntl.flock(lock_file.fileno(), fcntl.LOCK_EX | fcntl.LOCK_NB)
    except BlockingIOError:
        # Another instance is running, signal it to show
        server_name = "apt-ex-package-manager-instance"
        socket = QLocalSocket()
        socket.connectToServer(server_name)
        if socket.waitForConnected(1000):
            panel = "updates" if config.show_updates else "home"
            socket.write(QByteArray(f"show:{panel}".encode()))
            socket.waitForBytesWritten(1000)
            socket.disconnectFromServer()
        lock_file.close()
        return 0
    
    server_name = "apt-ex-package-manager-instance"
    QLocalServer.removeServer(server_name)
    server = QLocalServer()
    server.listen(server_name)
    
    app_controller = ApplicationController(app, config)
    
    def on_new_connection():
        client = server.nextPendingConnection()
        if client:
            client.waitForReadyRead(1000)
            data = client.readAll().data().decode()
            if data.startswith("show:"):
                panel = data.split(":", 1)[1] if ":" in data else "home"
                if app_controller.main_view:
                    window = app_controller.main_view
                    window.show()
                    window.raise_()
                    window.activateWindow()
                    app.alert(window, 0)
                    window.select_page(panel)
                elif app_controller.splash:
                    app_controller.splash.raise_()
                    app_controller.splash.activateWindow()
            client.disconnectFromServer()
    
    server.newConnection.connect(on_new_connection)
    
    if config.dev_outline:
        app.setStyleSheet("* { border: 1px solid red; }")
    
    app_controller.initialize()
    app_controller.show_main_window()
    
    try:
        sys.exit(app.exec())
    finally:
        server.close()
        app_controller.cleanup()
        fcntl.flock(lock_file.fileno(), fcntl.LOCK_UN)
        lock_file.close()
        try:
            os.remove(lock_file_path)
        except:
            pass

if __name__ == '__main__':
    main()
